<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index</title>
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="/assets/sweetalert/sweetalert2.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>Customer information</h1>
            <form id="frmCreate" action="">
                <div class="row mt-3">
                    <div class="col-lg-6">
                        <label for="fullName" class="fw-bold">Full Name</label>
                        <input type="text" id="fullName" name="fullName" class="form-control">
                    </div>
                    <div class="col-lg-6">
                        <label for="email" class="fw-bold">Email</label>
                        <input type="text" id="email" name="email" class="form-control">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-lg-6">
                        <label for="phone" class="fw-bold">Phone</label>
                        <input type="text" id="phone" name="phone" class="form-control">
                    </div>
                    <div class="col-lg-6">
                        <label for="address" class="fw-bold">Address</label>
                        <input type="text" id="address" name="address" class="form-control">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-lg-3">
                        <button type="button" id="btnCreate" class="btn btn-outline-primary">
                            <i class="fa-solid fa-plus"></i>
                            <span> Create</span>
                        </button>
                    </div>
                </div>
            </form>
        </header>

        <div class="content">
            <table id="tbCustomer" class="table table-hover mt-3">
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-center">Full Name</th>
                        <th class="text-center">Email</th>
                        <th class="text-center">Phone</th>
                        <th class="text-center">Address</th>
                        <th class="text-center">Balance</th>
                        <th colspan="5" class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <!-- end container -->

    <!-- Update Modal -->
    <div class="modal fade" id="mdUpdate" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal update</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="frmUpdate" action="" method="POST">
                        <div class="row mt-3">
                            <input type="hidden" id="idUp">
                            <div class="col-lg-6">
                                <label for="fullNameUp" class="fw-bold">Full Name</label>
                                <input type="text" id="fullNameUp" name="fullNameUp" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="emailUp" class="fw-bold">Email</label>
                                <input type="text" id="emailUp" name="emailUp" class="form-control">
                            </div>
                        </div>
                        <div class="row mt-3 mb-3">
                            <div class="col-lg-6">
                                <label for="phoneUp" class="fw-bold">Phone</label>
                                <input type="text" id="phoneUp" name="phoneUp" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="addressUp" class="fw-bold">Address</label>
                                <input type="text" id="addressUp" name="addressUp" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnUpdate" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-pen-to-square"></i>
                        Update
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Deposit Modal -->
    <div class="modal fade" id="mdDeposit" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal deposit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide"></div>

                    <form id="frmDeposit" action="">
                        <div class="row mt-3">
                            <div class="col-lg-6">
                                <label for="customerIdDep" class="fw-bold">Customer ID</label>
                                <input type="text" id="customerIdDep" name="customerIdDep" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="fullNameDep" class="fw-bold">Full Name</label>
                                <input type="text" id="fullNameDep" name="fullNameDep" class="form-control">
                            </div>
                        </div>
                        <div class="row mt-3 mb-3">
                            <div class="col-lg-6">
                                <label for="balanceDep" class="fw-bold">Balance</label>
                                <input type="text" id="balanceDep" name="balanceDep" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="transactionAmountDep" class="fw-bold">Transaction Amount</label>
                                <input type="text" id="transactionAmountDep" name="transactionAmountDep"
                                    class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnDeposit" class="btn btn-outline-success">
                        <i class="fa-solid fa-plus"></i>
                        Deposit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="mdWithdraw" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal Withdraw</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide"></div>

                    <form id="frmWithdraw" action="">
                        <div class="row mt-3">
                            <div class="col-lg-6">
                                <label for="customerIdWit" class="fw-bold">Customer ID</label>
                                <input type="text" id="customerIdWit" name="customerIdWit" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="fullNameWit" class="fw-bold">Full Name</label>
                                <input type="text" id="fullNameWit" name="fullNameWit" class="form-control">
                            </div>
                        </div>
                        <div class="row mt-3 mb-3">
                            <div class="col-lg-6">
                                <label for="balanceWit" class="fw-bold">Balance</label>
                                <input type="text" id="balanceWit" name="balanceWit" class="form-control">
                            </div>
                            <div class="col-lg-6">
                                <label for="transactionAmountWit" class="fw-bold">Transaction Amount</label>
                                <input type="text" id="transactionAmountWit" name="transactionAmountWit"
                                    class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnWithdraw" class="btn btn-outline-warning">
                        <i class="fa fa-minus"></i>
                        Withdraw
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Transfer -->
    <div class="modal fade " id="mdTransfer" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Modal Transfer</h5>
              <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close"> -->
                <!-- <span aria-hidden="true">&times;</span> -->
              <!-- </button> -->
            </div>
            <div class="modal-body">
                <form id="frmTransfer">
                    <div class="row">
                        <div class="col-lg-4">
                          
                            <label for="senderId">Sender Id</label>
                            <input type="text" id="senderIdTrf" readonly class="form-control">
                        </div>
                        <div class="col-lg-4">
                            <label for="senderName">Sender Name</label>
                            <input type="text" id="senderNameTrf" readonly class="form-control">
                        </div>
            
                        <div class="col-lg-4">
                            <label for="emailTra">Email</label>
                            <input type="email" id="emailTrf" readonly class="form-control">
                        </div>
                    </div>
                  
                    <div class="row mt-3">
                        <div class="col-lg-6">
                            <label for="balanceTra">Balance</label>
                            <input type="number" id="balanceTrf" readonly  class="form-control">
                        </div>
                        <div class="col-lg-6">
                            <label for="recipientIdTrf">Recipient Name</label>
                            <select class="form-control"  id="recipientIdTrf" name="recipientIdTrf">
                               
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-4">
                            <label for="transactionAmountTra">Transaction Amount</label>
                            <input type="number" id="transferAmountTrf" class="form-control">
                        </div>
                        <div class="col-lg-4">
                            <label for="fees">Fees(%)</label>
                            <input type="text" id="fees" readonly class="form-control">
                        </div>
            
                        <div class="col-lg-4">
                            <label for="transactionTotalTra">Total amount of transaction($)</label>
                            <input type="number" id="transactionAmountTrf" readonly class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" id="btnTranfers" class="btn btn-outline-primary">Tranfers</button>
            </div>
          </div>
        </div>
      </div>
    <script src="/assets/jquery/jquery-v3.6.0.min.js"></script>
    <script src="/assets/jquery/jquery.validate.min.js"></script>
    <script src="/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/sweetalert/sweetalert2.all.min.js"></script>

    <script src="/assets/js/app.model.js"></script>

    <script>
        function initTooltip() {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }

        let customer = new Customer();
        let deposit = new Deposit();
        let withdraw = new Withdraw();
        let transfer = new Transfer();
        
        
        let sender = new Sender();

        let recipient = new Recipient();


        function drawCustomers(data) {

            $('#tbCustomer tbody').empty();

            $.each(data, (i, item) => {
                let str = `
                    <tr id="tr_${item.id}">
                        <td>${item.id}</td>
                        <td>${item.fullName}</td>
                        <td>${item.email}</td>
                        <td class="text-center">${item.phone}</td>
                        <td>${item.address}</td>
                        <td class="text-end">${item.balance}</td>
                        <td>
                            <button class="btn btn-outline-secondary edit" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Update">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-success deposit" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Deposit">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-warning withdraw" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Withdraw">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-primary transfer" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Transfer">
                                <i class="fa-solid fa-right-left"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger delete" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                `;

                let tbCustomer = $('#tbCustomer tbody');
                tbCustomer.prepend(str);
            })

            initTooltip();

            handleShowModal();
        }

        function getCustomerById(id) {
            return $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: "http://localhost:3300/customers/" + id
            })
                .done((data) => {
                    customer = data;
                })
                .fail((jqXHR) => {

                })
        }

        function removeEventShowModal() {
            $(".edit").off();
            $(".deposit").off();
            $(".withdraw").off();
            $(".transfer").off();
            $(".delete").off();
        }

        function handleShowModal() {
            removeEventShowModal();
            handleShowUpdateModal();

            handleShowDepositModal();
            handleShowWithdrawModal();

            handleShowDeleteConfirm();
            handleShowTransfers();
        }

        function handleShowUpdateModal() {
            let btnUpdate = $(".edit");

            btnUpdate.on('click', function () {

                let id = $(this).data('id');

                getCustomerById(id).then(() => {
                    $("#idUp").val(customer.id);
                    $("#fullNameUp").val(customer.fullName);
                    $("#emailUp").val(customer.email);
                    $("#phoneUp").val(customer.phone);
                    $("#addressUp").val(customer.address);

                    $("#mdUpdate").modal('show');
                })
                    .catch(() => {
                        Swal.fire({
                            title: "Customer information invalid",
                            icon: 'error',
                        })
                    });
            })
        }

        function doTransfer(transfer) {
            return $.ajax({
                type: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: "http://localhost:3300/transfers",
                data: JSON.stringify(transfer),
                success: function() {
                    
                }
            });
        }

        $("#frmTransfer").validate({
            rules: {
                transferAmountTrf: {
                    required: true,
                    min: 50,
                    max: 10000000000
                }
            },
            messages: {
                transferAmountTrf: {
                    required: "Transfer amount is required",
                    min: "Transfer amount min is {0}",
                    max: "Transfer amount max is 10.000.000.000"
                }
            },
            submitHandler: function() {
                handlerTransfer();
            }
        });

        function handleShowTransfers(){

                let btnTransfers = $(".transfer");

            btnTransfers.on('click', function () {
                let id= $(this).data('id');
                getCustomerById(id).then(() => {
                    sender = customer;
                    $("#senderIdTrf").val(sender.id);
                    $("#senderNameTrf").val(sender.fullName);
                    $("#emailTrf").val(sender.email);
                    $("#balanceTrf").val(sender.balance);
                    $("#fees").val(10);
                    drawListRecipients(sender.id);
                    
                    $("#mdTransfer").modal("show");
                }).catch(function () {
                    alert("Sender not found!");
                });
            })
        }
        
        function drawListRecipients(senderId) {
            $.ajax({
                url: "http://localhost:3300/customers",
                success: function (recipients) {
                    $("#recipientIdTrf").empty();

                    recipients.forEach(item => {
                        if (item.id != senderId) {
                            let str = `
                                <option value="${item.id}">(${item.id}) ${item.fullName}</option>
                            `;

                            $("#recipientIdTrf").append(str);
                        }
                    });
                },
                error: function () {
                    
                }
            })
        }
        function updateSender(sender) {
            return $.ajax({
                type: "PUT",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: "http://localhost:3300/customers/" + sender.id,
                data: JSON.stringify(sender),
                success: function(data) {
                    let str = `
                        <tr id="tr_${data.id}">
                            <td>${data.id}</td>
                            <td>${data.fullName}</td>
                            <td>${data.email}</td>
                            <td>${data.phone}</td>
                            <td>${data.address}</td>
                            <td>${data.balance}</td>
                            <td>
                                <button type="button" class="btn btn-outline-secondary edit" data-id="${data.id}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-success deposit" data-id="${data.id}">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-warning withdraw" data-id="${data.id}">
                                    <i class="fa-solid fa-minus"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-primary transfer" data-id="${data.id}">
                                    <i class="fa-solid fa-arrow-right-arrow-left"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-danger delete" data-id="${data.id}">
                                    <i class="fa-solid fa-ban"></i>
                                </button>
                            </td>
                        </tr>
                    `;

                        let currentRow = $("#tr_" + data.id);
                        currentRow.replaceWith(str);
                }
            });
        }

        function updateRecipient(recipient) {
            return $.ajax({
                type: "PUT",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: "http://localhost:3300/customers/" + recipient.id,
                data: JSON.stringify(recipient),
                success: function(data) {
                    let str = `
                        <tr id="tr_${data.id}">
                            <td>${data.id}</td>
                            <td>${data.fullName}</td>
                            <td>${data.email}</td>
                            <td>${data.phone}</td>
                            <td>${data.address}</td>
                            <td>${data.balance}</td>
                            <td>
                                <button type="button" class="btn btn-outline-secondary edit" data-id="${data.id}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-success deposit" data-id="${data.id}">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-warning withdraw" data-id="${data.id}">
                                    <i class="fa-solid fa-minus"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-primary transfer" data-id="${data.id}">
                                    <i class="fa-solid fa-arrow-right-arrow-left"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-danger delete" data-id="${data.id}">
                                    <i class="fa-solid fa-ban"></i>
                                </button>
                            </td>
                        </tr>
                    `;

                    let currentRow = $("#tr_" + data.id);
                    currentRow.replaceWith(str);
                }
            });
        }

        function handlerTransfer() {
            let transferAmount = +$("#transferAmountTrf").val();
            let fees = 10;
            let feesAmount = transferAmount / fees;
            let transactionAmount = transferAmount + feesAmount;

            if (transactionAmount > sender.balance) {
                alert("Customer balance not enough money to transfer");
            }
            else {
                sender.balance -= transactionAmount;

                updateSender(sender).then(function () {
                    let recipientId = $("#recipientIdTrf").val();

                    findById(recipientId).then(function () {
                        recipient = customer;

                        recipient.balance += transferAmount;

                        updateRecipient(recipient).then(function () {
                            transfer.senderId = sender.id;
                            transfer.recipientId = recipient.id;
                            transfer.transferAmount = transferAmount;
                            transfer.fees = 10;
                            transfer.feesAmount = feesAmount;
                            transfer.transactionAmount = transactionAmount;
                            
                            doTransfer(transfer).then(function () {
                                $("#mdTransfer").modal("hide");

                                handleShowModal();
                                $("#frmTransfer")[0].reset();
                            })
                        })
                    }); 
                })
            }
        }
        $("#mdTransfer").on("hidden.bs.modal", function () {
            $('#frmTransfer')[0].reset();
            $('#frmTransfer').validate().resetForm();
            $("#frmTransfer input.error").removeClass("error");
        });

        $("#transferAmountTrf").on("input", function () {
            let transferAmount = +$(this).val();
            let fees = 10;
            let feesAmount = transferAmount / fees;
            let transactionAmount = transferAmount + feesAmount;

            $("#transactionAmountTrf").val(transactionAmount);
        })
        
       

        function handleShowDepositModal() {
            let btnDeposit = $(".deposit");

            btnDeposit.on('click', function () {

                let id = $(this).data('id');

                getCustomerById(id).then(() => {
                    $("#customerIdDep").val(customer.id);
                    $("#fullNameDep").val(customer.fullName);
                    $("#balanceDep").val(customer.balance);

                    $("#mdDeposit").modal('show');
                })
                    .catch(() => {
                        Swal.fire({
                            title: "Customer information invalid",
                            icon: 'error',
                        })
                    });
            })
        }

        function handleShowWithdrawModal() {
            let btnWithdraw = $(".withdraw");

            btnWithdraw.on('click', function () {

                let id = $(this).data('id');

                getCustomerById(id).then(() => {
                    $("#customerIdWit").val(customer.id);
                    $("#fullNameWit").val(customer.fullName);
                    $("#balanceWit").val(customer.balance);

                    $("#mdWithdraw").modal('show');
                })
                    .catch(() => {
                        // Swal.fire({
                        //     title: "Customer information invalid",
                        //     icon: 'error',
                        // })
                    });
            })
        }

        function handleShowDeleteConfirm() {
            let btnDelete = $(".delete");

            btnDelete.on('click', function () {

                let customerId = $(this).data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {

                        getCustomerById(customerId).then(() => {

                            customer.deleted = 1;

                            $.ajax({
                                headers: {
                                    "accept": "application/json",
                                    "content-type": "application/json"
                                },
                                type: "PUT",
                                url: "http://localhost:3300/customers/" + customerId,
                                data: JSON.stringify(customer)
                            })
                                .done(() => {
                                    $("#tr_" + customerId).remove();

                                    Swal.fire({
                                        title: "The client has been deleted.",
                                        icon: 'success',
                                        showConfirmButton: false,
                                        timer: 2000,
                                        position: 'top-end',
                                    })
                                })
                                .fail((jqXHR) => {
                                    console.log(jqXHR);
                                })
                        })
                            .catch((jqXHR) => {
                                Swal.fire({
                                    title: "Customer information invalid",
                                    icon: 'error',
                                })
                            })
                    }
                })
            })
        }

        getAllCustomers();

        function getAllCustomers() {
            $.ajax({
                headers: {
                    "Accept": "application/json",
                    "Content-type": "application/json"
                },
                type: "GET",
                url: 'http://localhost:3300/customers?deleted=0&_sort=id&_order=desc'
            })
                .done((data) => {
                    drawCustomers(data);
                })
                .fail((jqXHR) => {
                    console.log(jqXHR);
                });
        }

        let btnCreate = $('#btnCreate');

        btnCreate.on('click', () => {

            let fullName = $('#fullName').val();
            let email = $('#email').val();
            let phone = $('#phone').val();
            let address = $('#address').val();

            customer = new Customer(0, fullName, email, phone, address, 0, 0);
            delete customer.id;

            $.ajax({
                headers: {
                    "Accept": "application/json",
                    "Content-type": "application/json"
                },
                type: "POST",
                url: 'http://localhost:3300/customers',
                data: JSON.stringify(customer)
            })
                .done((item) => {
                    let str = `
                    <tr id="tr_${item.id}">
                        <td>${item.id}</td>
                        <td>${item.fullName}</td>
                        <td>${item.email}</td>
                        <td class="text-center">${item.phone}</td>
                        <td>${item.address}</td>
                        <td class="text-end">${item.balance}</td>
                        <td>
                            <button class="btn btn-outline-secondary edit" data-id="${item.id}" data-fullname="${item.fullName}" data-email="${item.email}" data-phone="${item.phone}" data-address="${item.address}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Update">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-success deposit" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Deposit">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-warning withdraw" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Withdraw">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-primary transfer" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Transfer">
                                <i class="fa-solid fa-right-left"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger delete" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                `;

                    let tbCustomer = $('#tbCustomer tbody');
                    tbCustomer.prepend(str);
                    // $("#frmCreate")[0].reset();
                    Swal.fire({
                        title: "The client has been deleted.",
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 2000,
                        position: 'top-end',
                    })

                    initTooltip();

                    handleShowModal();

                })
                .fail((jqXHR) => {
                    console.log(jqXHR);
                });

            // drawCustomers();
        });


        function doUpdate() {
            let customerId = +$("#idUp").val();
            let fullName = $('#fullNameUp').val();
            let email = $('#emailUp').val();
            let phone = $('#phoneUp').val();
            let address = $('#addressUp').val();

            customer = new Customer(customerId, fullName, email, phone, address, 0, 0);

            $.ajax({
                headers: {
                    "Accept": "application/json",
                    "Content-type": "application/json"
                },
                type: "PUT",
                url: 'http://localhost:3300/customers/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((item) => {

                    let str = `
                <tr id="tr_${item.id}">
                    <td>${item.id}</td>
                    <td>${item.fullName}</td>
                    <td>${item.email}</td>
                    <td class="text-center">${item.phone}</td>
                    <td>${item.address}</td>
                    <td class="text-end">${item.balance}</td>
                    <td>
                        <button class="btn btn-outline-secondary edit" data-id="${item.id}" data-fullname="${item.fullName}" data-email="${item.email}" data-phone="${item.phone}" data-address="${item.address}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Update">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-outline-success deposit" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Deposit">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-outline-warning withdraw" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Withdraw">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary transfer" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Transfer">
                            <i class="fa-solid fa-right-left"></i>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-outline-danger delete" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                </tr>
            `;

                    let currentRow = $("#tr_" + item.id);
                    currentRow.replaceWith(str);

                    $("#mdUpdate").modal('hide');

                    initTooltip();

                    removeEventShowModal();

                    handleShowModal();
                    Swal.fire({
                        title: "The client has been deleted.",
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 2000,
                        position: 'top-end',
                    })
                })
                .fail((jqXHR) => {
                    console.log(jqXHR);
                });
        }

        let btnUpdate = $("#btnUpdate");
        btnUpdate.on('click', () => {
            $("#frmUpdate").submit();
        });

        let btnTransfer = $("#btnTranfers");
        btnTransfer.on('click', () => {
            $("#frmTransfer").submit();
        });

        // $("#btnTranfers").on("click", function () {
        //     $("#frmTransfer").submit();
        // });

        function doDeposit() {
            let customerId = +$("#customerIdDep").val();
            let transactionAmount = +$('#transactionAmountDep').val();

            getCustomerById(customerId).then(() => {
                deposit = new Deposit(null, customerId, transactionAmount);

                let currentBalance = customer.balance;

                let newBalance = currentBalance + transactionAmount;

                customer.balance = newBalance;

                $.ajax({
                    headers: {
                        "Accept": "application/json",
                        "Content-type": "application/json"
                    },
                    type: "POST",
                    url: 'http://localhost:3300/deposits',
                    data: JSON.stringify(deposit)
                })
                    .done((item) => {

                        $.ajax({
                            headers: {
                                "Accept": "application/json",
                                "Content-type": "application/json"
                            },
                            type: "PUT",
                            url: 'http://localhost:3300/customers/' + customerId,
                            data: JSON.stringify(customer)
                        })
                            .done((item) => {
                                let str = `
                                <tr id="tr_${item.id}">
                                    <td>${item.id}</td>
                                    <td>${item.fullName}</td>
                                    <td>${item.email}</td>
                                    <td class="text-center">${item.phone}</td>
                                    <td>${item.address}</td>
                                    <td class="text-end">${item.balance}</td>
                                    <td>
                                        <button class="btn btn-outline-secondary edit" data-id="${item.id}" data-fullname="${item.fullName}" data-email="${item.email}" data-phone="${item.phone}" data-address="${item.address}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Update">
                                            <i class="fa-solid fa-pen-to-square"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-success deposit" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Deposit">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-warning withdraw" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Withdraw">
                                            <i class="fa-solid fa-minus"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-primary transfer" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Transfer">
                                            <i class="fa-solid fa-right-left"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-danger delete" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;

                                let currentRow = $("#tr_" + item.id);
                                currentRow.replaceWith(str);

                                $("#mdDeposit").modal('hide');

                                initTooltip();

                                removeEventShowModal();

                                handleShowModal();
                                Swal.fire({
                                    title: "The client has been deleted.",
                                    icon: 'success',
                                    showConfirmButton: false,
                                    timer: 2000,
                                    position: 'top-end',
                                })

                                $("#frmDeposit")[0].reset();
                            })
                            .fail((jqXHR) => {

                            })
                    })
                    .fail((jqXHR) => {
                        console.log(jqXHR);
                    });
            })
                .catch(() => {

                })
        }

        function doWithdraw() {
            let customerId = +$("#customerIdWit").val();
            let transactionAmount = +$('#transactionAmountWit').val();

            getCustomerById(customerId).then(() => {
                withdraw = new Withdraw(null, customerId, transactionAmount);

                let currentBalance = customer.balance;
                if (currentBalance >= transactionAmount) {
                    let newBalance = currentBalance - transactionAmount;
                    customer.balance = newBalance;
                } else {
                    // alert ("Số tiền cần chuyển phải <= số tiền hiện có");
                    Swal.fire({
                        title: "Số tiền muốn rút phải bé hơn hoặc bằng số tiền hiện có!  ",
                        icon: 'error',
                    })
                }
                $.ajax({
                    headers: {
                        "Accept": "application/json",
                        "Content-type": "application/json"
                    },
                    type: "POST",
                    url: 'http://localhost:3300/withdraws',
                    data: JSON.stringify(withdraw)
                })
                    .done((item) => {

                        $.ajax({
                            headers: {
                                "Accept": "application/json",
                                "Content-type": "application/json"
                            },
                            type: "PUT",
                            url: 'http://localhost:3300/customers/' + customerId,
                            data: JSON.stringify(customer)
                        })
                            .done((item) => {
                                let str = `
                                <tr id="tr_${item.id}">
                                    <td>${item.id}</td>
                                    <td>${item.fullName}</td>
                                    <td>${item.email}</td>
                                    <td class="text-center">${item.phone}</td>
                                    <td>${item.address}</td>
                                    <td class="text-end">${item.balance}</td>
                                    <td>
                                        <button class="btn btn-outline-secondary edit" data-id="${item.id}" data-fullname="${item.fullName}" data-email="${item.email}" data-phone="${item.phone}" data-address="${item.address}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Update">
                                            <i class="fa-solid fa-pen-to-square"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-success deposit" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Deposit">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-warning withdraw" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Withdraw">
                                            <i class="fa-solid fa-minus"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-primary transfer" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Transfer">
                                            <i class="fa-solid fa-right-left"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-danger delete" data-id="${item.id}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;

                                let currentRow = $("#tr_" + item.id);
                                currentRow.replaceWith(str);


                                $("#mdWithdraw").modal('hide');

                                initTooltip();

                                removeEventShowModal();

                                handleShowModal();
                                Swal.fire({
                                    title: "The client has been deleted.",
                                    icon: 'success',
                                    showConfirmButton: false,
                                    timer: 2000,
                                    position: 'top-end',
                                })     

                                $("#frmWithdraw")[0].reset();

                            })

                    })
                    .fail((jqXHR) => {
                        console.log(jqXHR);
                    });

            })
                .catch(() => {

                })
        }


        let btnDeposit = $("#btnDeposit");

        btnDeposit.on('click', () => {
            $("#frmDeposit").submit();
        })


        $("#mdDeposit").on('hidden.bs.modal', () => {
            $("#mdDeposit .modal-alert-danger").removeClass("show").addClass("hide");
            $("#frmDeposit").validate().resetForm();
        })


        $("#frmUpdate").validate({
            rules: {
                fullNameUp: {
                    required: true,
                    minlength: 5,
                    maxlength: 30
                },
                emailUp: {
                    required: true,
                    // email: true,
                    // isEmail: true,
                    valid_email: true,
                    minlength: 5,
                    maxlength: 30
                },
                phoneUp: {
                    required: true,
                    
                    digits: true,
                    minlength:10, 
                    maxlength:10
                },
                addressUp: {
                    required: true,
                    minlength: 3,
                    maxlength: 30
                }
            },
            messages: {
                fullNameUp: {
                    required: "Vui lòng nhập tên đầy đủ",
                    minlength: "Độ dài tên tối thiểu là 5",
                    maxlength: "ĐỘ dài tên tối đa là 30"
                },
                emailUp: {
                    required: "Vui lòng nhập email đầy đủ",
                    // email: "Vui lòng nhập đúng định dạng email",
                    // isEmail: "Vui lòng nhập đúng định dạng email",
                    
                    minlength: "Độ dài email tối thiểu là 5",
                    maxlength: "ĐỘ dài email tối đa là 30"
                },
                phoneUp: {
                    required: "Vui lòng nhập số điện thoại đầy đủ",
                   
                    digits: "Trường này chỉ nhập số",
                    minlength: "Độ dài tên tối thiểu là 10",
                    maxlength: "ĐỘ dài tên tối đa là 10"
                },
                addressUp: {
                    required: "Vui lòng nhập địa chỉ đầy đủ",
                    minlength: "Độ dài tên tối thiểu là 5",
                    maxlength: "ĐỘ dài tên tối đa là 30"
                }
            },
            submitHandler: function () {
                doUpdate();
            }
        })
        jQuery.validator.addMethod('valid_email', function (value) {
        var regex = /^[a-z0-9]+([-._][a-z0-9]+)*@([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{1,5}$/;
        return value.trim().match(regex);
        }, "Nhập đúng định dạng email");

        // $("#frmCreate").validate({
        //     rules: {
        //         fullNameUp: {
        //             required: true,
        //             minlength: 5,
        //             maxlength: 30
        //         },
        //         emailUp: {
        //             required: true,
        //             // email: true,
        //             // isEmail: true,
        //             valid_email: true,
        //             minlength: 5,
        //             maxlength: 30
        //         },
        //         phoneUp: {
        //             required: true,
        //             matches:"[0-9]+",
        //             digits: true,
        //             minlength:10, 
        //             maxlength:10
        //         },
        //         addressUp: {
        //             required: true,
        //             minlength: 5,
        //             maxlength: 30
        //         }
        //     },
        //     messages: {
        //         fullNameUp: {
        //             required: "Vui lòng nhập tên đầy đủ",
        //             minlength: "Độ dài tên tối thiểu là 5",
        //             maxlength: "ĐỘ dài tên tối đa là 30"
        //         },
        //         emailUp: {
        //             required: "Vui lòng nhập email đầy đủ",
        //             // email: "Vui lòng nhập đúng định dạng email",
        //             // isEmail: "Vui lòng nhập đúng định dạng email",
                    
        //             minlength: "Độ dài email tối thiểu là 5",
        //             maxlength: "ĐỘ dài email tối đa là 30"
        //         },
        //         phoneUp: {
        //             required: "Vui lòng nhập số điện thoại đầy đủ",
        //             matches: "Nhập đúng định dạng sđt",
        //             digits: "Trường này chỉ nhập số",
        //             minlength: "Độ dài tên tối thiểu là 10",
        //             maxlength: "ĐỘ dài tên tối đa là 10"
        //         },
        //         addressUp: {
        //             required: "Vui lòng nhập địa chỉ đầy đủ",
        //             minlength: "Độ dài tên tối thiểu là 5",
        //             maxlength: "ĐỘ dài tên tối đa là 30"
        //         }
        //     },
        //     submitHandler: function () {
        //         doUpdate();
        //     }
        // })

        $("#frmDeposit").validate({
            rules: {
                transactionAmountDep: {
                    required: true,
                    isNumberWithSpace: true
                }
            },
            messages: {
                transactionAmountDep: {
                    required: "Vui lòng nhập số tiền giao dịch",
                }
            },
            errorLabelContainer: "#mdDeposit .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#mdDeposit .modal-alert-danger");
            },
            showErrors: function (errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#mdDeposit .modal-alert-danger").removeClass("hide").addClass("show");
                } else {
                    $("#mdDeposit .modal-alert-danger").removeClass("show").addClass("hide").empty();
                    $("#frmDeposit input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: function () {
                doDeposit();
            }
        })

        $.validator.addMethod("isNumberWithSpace", function (value, element) {
            return this.optional(element) || /^\s*[0-9,\s]+\s*$/i.test(value);
        }, "Vui lòng nhập giá trị số");


        let btnWithdraw = $("#btnWithdraw");

        btnWithdraw.on('click', () => {
            $("#frmWithdraw").submit();
        })


        $("#mdWithdraw").on('hidden.bs.modal', () => {
            $("#mdWithdraw .modal-alert-danger").removeClass("show").addClass("hide");
            $("#frmWithdraw").validate().resetForm();
        })


        $("#frmWithdraw").validate({
            rules: {
                transactionAmountWit: {
                    required: true,
                    min: 50,
                    max: 10000000000
                }
            },
            messages: {
                transactionAmountWit: {
                    required: "Transaction amount is required",
                    min: "Transaction amount min is 50",
                    max: "Transaction amount max is 10.000.000.000"
                }
            },
            submitHandler: function() {
                doWithdraw();
            }
        });



    </script>
</body>

</html>