<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="/HTML Bootstrap Jquery Customer management Single page/assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="/HTML Bootstrap Jquery Customer management Single page/assets/css/style.css">
</head>

<body>
  <div class="container">
    <!-- <form id="frmCreate" class="mb-3">
      <div class="row">
        <div class="mb-3 col-xl-6">
          <label for="exampleInputEmail1" class="form-label">FullName</label>
          <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Full Name">
        </div>
        <div class="mb-3 col-xl-6">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" name="email" placeholder="Email">
        </div>
      </div>
      <div class="row">
        <div class="mb-3 col-xl-6">
          <label for="phone" class="form-label">Phone</label>
          <input type="text" class="form-control" id="phone" name="phone" placeholder="Phone">
        </div>
        <div class="mb-3 col-xl-6">
          <label for="address" class="form-label">Address</label>
          <input type="text" class="form-control" id="address" name="address" placeholder="Address">
        </div>
      </div>
      <div class="row">
        <div class="col-xl-3">
          <button type="button" class="btn btn-outline-primary" id="btnCreate">Create</button>
        </div>
      </div>
    </form> -->

    <div class="row mt-3">
      <div class="col-xl-7">
        <h1>Customer Infomation</h1>
      </div>
      <div class="col-xl-5 mt-2">
        <button id="createCustomer" class="btn btn-outline-primary float-end">
          Create New Customer
        </button>
      </div>
    </div>

    <table class="table table-hover" id="tbCustomer">
      <thead>
        <tr style="background-color: #4caf50">
          <th scope="col">#</th>
          <th scope="col">FullName</th>
          <th scope="col">Email</th>
          <th scope="col">Phone</th>
          <th scope="col">Address</th>
          <th scope="col">Balance</th>
          <th scope="col" class="text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
                <th scope="row">1</th>
                <td>Mark</td>
                <td>Otto</td>
                <td>2345</td>
                <td>28 NTP</td>
                <td>10000000</td>
                <td>  
                  <button href="" type="button" class="btn btn-outline-secondary" id="btnEdit"> <i class="fas fa-pen-square"></i> </button>
                  <button type="button" class="btn btn-outline-success" id="btnDeposit"> <i class="fas fa-plus"></i> </button>
                  <button type="button" class="btn btn-outline-primary" id="btnWithdraw"> <i class="fas fa-minus"></i> </button>
                  <button type="button" class="btn btn-outline-warning" id="btnTransfer"> <i class="fas fa-exchange-alt"></i> </button>
                  <button type="button" class="btn btn-outline-danger" id="btnBlock"> <i class="fas fa-ban"></i> </button>  
                </td>
              </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Create -->
  <div id="mdCreate" class="modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-alert-danger hide">
        </div>
        <form id="frmCreate">
          <div class="modal-body">
            <div class="row">
              <div class="mb-3 col-xl-6">
                <label for="fullNameUp" class="form-label">FullName</label>
                <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Full Name">
              </div>
              <div class="mb-3 col-xl-6">
                <label for="emailUp" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="Email">
              </div>
            </div>
            <div class="row">
              <div class="mb-3 col-xl-6">
                <label for="phoneUp" class="form-label">Phone</label>
                <input type="text" class="form-control" id="phone" name="phone" placeholder="Phone">
              </div>
              <div class="mb-3 col-xl-6">
              <label for="province" class="form-label">Address</label>
              <input type="text" class="form-control" id="address" name="address" placeholder="Address">
              </div>
            </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-outline-primary" id="btnCreate">Create</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- Modal Edit -->
  <div id="mdEdit" class="modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="mb-3 col-xl-6">
              <label for="fullNameUp" class="form-label">FullName</label>
              <input type="text" class="form-control" id="fullNameUp" placeholder="Full Name">
            </div>
            <div class="mb-3 col-xl-6">
              <label for="emailUp" class="form-label">Email</label>
              <input type="email" class="form-control" id="emailUp">
            </div>
          </div>

          <div class="row">
            <div class="mb-3 col-xl-6">
              <label for="phoneUp" class="form-label">Phone</label>
              <input type="text" class="form-control" id="phoneUp" placeholder="Phone">
            </div>
            <div class="mb-3 col-xl-6">
              <label for="addressUp" class="form-label">Address</label>
              <input type="text" class="form-control" id="addressUp">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-outline-primary" id="btnEdit">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Deposit -->
  <div id="mdDeposit" class="modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Deposit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="frmDeposit">
            <div class="row">
              <div class="mb-3 col-xl-6">
                <label for="customerIdDepositUp" class="form-label">Customer Id</label>
                <input type="number" class="form-control" id="customerIdDepositUp" disabled placeholder="ID">
              </div>
              <div class="mb-3 col-xl-6">
                <label for="fullNameDepositUp" class="form-label">FullName</label>
                <input type="text" class="form-control" id="fullNameDepositUp" placeholder="Full Name" disabled>
              </div>

            </div>

            <div class="row">
              <div class="mb-3 col-xl-6">
                <label for="balanceDepositUp" class="form-label">Current balance ($)</label>
                <input type="number" class="form-control" id="balanceDepositUp" placeholder="Balance" disabled>
              </div>
              <div class="mb-3 col-xl-6">
                <label for="transactionAmountUp" class="form-label">Transaction Amount ($)</label>
                <input type="number" class="form-control" id="transactionAmountUp" placeholder="Transaction Amount">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-outline-success" id="btnDeposit">Deposit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Withdraw -->

  <div id="mdWithdraw" class="modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Withdraw</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="frmWithdraw">
            <div class="row">
              <div class="mb-3 col-xl-6">
                <label for="customerIdWithdraw" class="form-label">Customer Id</label>
                <input type="number" class="form-control" id="customerIdWithdraw" disabled placeholder="ID">
              </div>
              <div class="mb-3 col-xl-6">
                <label for="fullNameWithdraw" class="form-label">FullName</label>
                <input type="text" class="form-control" id="fullNameWithdraw" placeholder="Full Name" disabled>
              </div>

            </div>

            <div class="row">
              <div class="mb-3 col-xl-6">
                <label for="balanceWithdraw" class="form-label">Current balance ($)</label>
                <input type="number" class="form-control" id="balanceWithdraw" placeholder="Balance" disabled>
              </div>
              <div class="mb-3 col-xl-6">
                <label for="transactionAmountWithdraw" class="form-label">Transaction Amount ($)</label>
                <input type="number" class="form-control" id="transactionAmountWithdraw"
                  placeholder="Transaction Amount">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-outline-warning" id="btnWithdraw">Withdraw</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Transfer -->

  <div id="mdTransfer" class="modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Transfer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="frmTransfer">
            <div class="row">
              <div class="mb-3 col-xl-3">
                <label for="senderId" class="form-label">Sender Id</label>
                <input type="number" class="form-control" id="senderId" disabled placeholder="Sender Id">
              </div>
              <div class="mb-3 col-xl-3">
                <label for="senderName" class="form-label">Sender Name</label>
                <input type="text" class="form-control" id="senderName" placeholder="Sender Name" disabled>
              </div>
              <div class="mb-3 col-xl-3">
                <label for="senderEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="senderEmail" disabled placeholder="Email">
              </div>
              <div class="mb-3 col-xl-3">
                <label for="senderBalance" class="form-label">Sender Balance</label>
                <input type="text" class="form-control" id="senderBalance" placeholder="Sender Balance" disabled>
              </div>

            </div>

            <div class="row">
              <div class="mb-3 col-xl-3">
                <label for="repName" class="form-label">Repcipient Name</label>
                <select name="repName" id="repName" aria-placeholder="Repcipient Name" class="form-control">
                </select>
              </div>
              <div class="mb-3 col-xl-3">
                <label for="transferAmount" class="form-label">Transfer Amount ($)</label>
                <input type="number" class="form-control" id="transferAmount" placeholder="Transfer Amount">
              </div>
              <div class="mb-3 col-xl-3">
                <label for="fees" class="form-label">Fees (%))</label>
                <input type="number" class="form-control" id="fees" placeholder="Fees" disabled value="10">
              </div>
              <div class="mb-3 col-xl-3">
                <label for="transactionAmountTransfer" class="form-label">Transaction Amount ($)</label>
                <input type="number" class="form-control" id="transactionAmountTransfer" disabled
                  placeholder="Transaction Amount">
              </div>

            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-outline-primary" id="btnTransfer">Transfer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/HTML Bootstrap Jquery Customer management Single page/assets/js/bootstrap.bundle.min.js"></script>
  <script src="/HTML Bootstrap Jquery Customer management Single page/assets/js/jquery-3.6.0.min.js"></script>
  <script src="/HTML Bootstrap Jquery Customer management Single page/assets//js/jquery.validate.min.js"></script>
  <script src="/HTML Bootstrap Jquery Customer management Single page/assets/js/app.js"></script>


  <script>
    let customers = [];
    let customer = new Customer();
    let deposit = new Deposit();
    let withdraw = new Withdraw();
    let transfer = new Transfer();

    function updateSender(id, transferAmount) {
      return findCustomerById(id).then(function () {
        console.log(customer.balance);
        customer.balance = Number(customer.balance) - Number(transferAmount * 1.1);

      return $.ajax({
          type: "PUT",
          url: "http://localhost:3000/customer/" + customer.id,
          data: customer
        }).done((data) => {
          console.log(data.balance);
          let str = `  <tr id = "tr_${data.id}">
                          <th scope="row">${data.id}</th>
                          <td>${data.fullName}</td>
                          <td>${data.email}</td>
                          <td>${data.phone}</td>
                          <td>${data.address}</td>
                          <td>${data.balance}</td>
                          <td class="text-center">
                              <button type="button" class="btn btn-outline-secondary edit" data-id = "${data.id}"> <i class="fas fa-pen-square"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-success deposit" id="btnDeposit(${data.id})"> <i class="fas fa-plus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-warning withdraw" id="btnWithdraw(${data.id})"> <i class="fas fa-minus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-primary transfer" id="btnTransfer(${data.id})"> <i class="fas fa-exchange-alt"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-danger block" id="btnBlock(${data.id})"> <i class="fas fa-ban"></i> </button>  
                          </td>
             </tr>`;
          let currentRow = $("#tr_" + data.id);
          currentRow.replaceWith(str);

          handleEditBtn();
        }).fail((data) => {
          alert("Update Sender Name Fail!");
        })
      })
    }

    function updateRep(id, transferAmount) {
      return findCustomerById(id).then(function () {
        customer.balance = Number(customer.balance) + Number(transferAmount);

      return  $.ajax({
          type: "PUT",
          url: "http://localhost:3000/customer/" + customer.id,
          data: customer
        }).done((data) => {
          console.log(data.balance);
          let str = `  <tr id = "tr_${data.id}">
                          <th scope="row">${data.id}</th>
                          <td>${data.fullName}</td>
                          <td>${data.email}</td>
                          <td>${data.phone}</td>
                          <td>${data.address}</td>
                          <td>${data.balance}</td>
                          <td class="text-center">
                              <button type="button" class="btn btn-outline-secondary edit" data-id = "${data.id}"> <i class="fas fa-pen-square"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-success deposit" id="btnDeposit(${data.id})"> <i class="fas fa-plus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-warning withdraw" id="btnWithdraw(${data.id})"> <i class="fas fa-minus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-primary transfer" id="btnTransfer(${data.id})"> <i class="fas fa-exchange-alt"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-danger block" id="btnBlock(${data.id})"> <i class="fas fa-ban"></i> </button>  
                          </td>
             </tr>`;
          let currentRow = $("#tr_" + data.id);
          currentRow.replaceWith(str);
          $("#repName").html("");
          handleEditBtn();
        }).fail((data) => {
          alert("Update Rep Name Fail!");
        })
      })
    }

    $("#btnTransfer").on("click", function () {
      let id = $("#senderId").val();
      console.log(id);
      let transferAmount = $("#transferAmount").val();
      let repId = $("#repName").val();
      let hasError = false;

      if (Number(transferAmount) == NaN) {
        alert("Vui lòng nhập đúng số tiền chuyển khoản!");
        hasError = true;
      } else {

        if (transferAmount < 50) {
          alert("Số tiền chuyển khoản phải lớn hơn 50!");
          hasError = true;
        } else if (transferAmount * 1.1 > customer.balance) {
          alert("Số tiền chuyển khoản vượt quá số dư của bạn!");
          hasError = true;
        } else if (transferAmount > 1000000000) {
          alert("Số tiền chuyển khoản tối đa mỗi lần 1.000.000.000đ");
          hasError = true;
        }

      }




      updateSender(id, transferAmount).then(function(){
        updateRep(repId, transferAmount);
      })
      

      delete transfer.id;
      transfer.createAt = getDatetime();
      transfer.createBy = 1;
      transfer.isDeleted = 0;
      transfer.updateAt = getDatetime();
      transfer.updateBy = 1;
      transfer.fees = 10;
      transfer.feesAmount = transferAmount * 0.1;
      transfer.transactionAmount = transferAmount * 1.1;
      transfer.transferAmount = transferAmount;
      transfer.senderId = id;
      transfer.repId = Number(repId);

      $.ajax({
        type: "POST",
        url: "http://localhost:3000/transfer",
        data: transfer
      }).done((data) => {
        // console.log(data.balance);
      }).fail((err) => {
        alert("Create Transfer Fail!");
      })

      $("#mdTransfer").modal("hide");

    })

    $("#btnWithdraw").on("click", function () {
      let id = $('#customerIdWithdraw').val();
      let hasError = false;
      findCustomerById(id).then(function () {
        let transactionAmount = $('#transactionAmountWithdraw').val();


        if (Number(transactionAmount) == NaN) {
          alert("Vui lòng nhập đúng số tiền rút!");
          hasError = true;
        } else {

          if (transactionAmount < 50) {
            alert("Số tiền rút phải lớn hơn 50!");
            hasError = true;
          } else if (transactionAmount > customer.balance) {
            alert("Số tiền bạn muốn rút vượt quá số dư của bạn!");
            hasError = true;
          } else if (transactionAmount > 1000000000) {
            alert("Số tiền rút tối đa mỗi lần 1.000.000.000đ");
            hasError = true;
          }

        }

        if (!hasError) {
          customer.balance = customer.balance - transactionAmount;

          delete withdraw.id;
          withdraw.customerId = id;
          withdraw.createAt = getDatetime();
          withdraw.createBy = 1;
          withdraw.updateAt = getDatetime();
          withdraw.updateBy = 1;
          withdraw.isDeleted = 0;
          withdraw.transactionAmount = transactionAmount;

          $.ajax({
            type: "POST",
            url: "http://localhost:3000/withdraw",
            data: withdraw
          })

          $.ajax({
            type: "PUT",
            url: "http://localhost:3000/customer/" + customer.id,
            data: customer
          }).done((data) => {
            let str = `  <tr id = "tr_${data.id}">
                          <th scope="row">${data.id}</th>
                          <td>${data.fullName}</td>
                          <td>${data.email}</td>
                          <td>${data.phone}</td>
                          <td>${data.address}</td>
                          <td>${data.balance}</td>
                          <td class="text-center">
                              <button type="button" class="btn btn-outline-secondary edit" data-id = "${data.id}"> <i class="fas fa-pen-square"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-success deposit" id="btnDeposit(${data.id})"> <i class="fas fa-plus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-warning withdraw" id="btnWithdraw(${data.id})"> <i class="fas fa-minus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-primary transfer" id="btnTransfer(${data.id})"> <i class="fas fa-exchange-alt"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-danger block" id="btnBlock(${data.id})"> <i class="fas fa-ban"></i> </button>  
                          </td>
             </tr>`;
            let currentRow = $("#tr_" + data.id);
            currentRow.replaceWith(str);

            handleEditBtn();
            $("#mdWithdraw").modal("hide");
          })
        }
      })
    })

    $("#btnDeposit").on("click", function () {
      let id = $('#customerIdDepositUp').val();
      let hasError = false;
      findCustomerById(id).then(function () {
        let transactionAmount = $('#transactionAmountUp').val();

        if (Number(transactionAmount) == NaN) {
          alert("Vui lòng nhập đúng số tiền muốn nạp!");
          hasError = true;
        } else {

          if (transactionAmount < 50) {
            alert("Số tiền nạp phải lớn hơn 50!");
            hasError = true;
          } else if (transactionAmount > 1000000000) {
            alert("Số tiền nạp tối đa mỗi lần 1.000.000.000đ");
            hasError = true;
          }
        }



        if (!hasError) {
          

          delete deposit.id;
          deposit.customerId = id;
          deposit.createAt = getDatetime();
          deposit.createBy = 1;
          deposit.updateAt = getDatetime();
          deposit.updateBy = 1;
          deposit.transactionAmount = transactionAmount;
          deposit.isDeleted = 0;

          $.ajax({
            type: "POST",
            url: "http://localhost:3000/deposit",
            data: deposit
          })
            .done((data) => {

            })
            .fail((err) => {
              alert("Fail!")
            })


            customer.balance = Number(customer.balance) + Number(transactionAmount);


          $.ajax({
            type: "PUT",
            url: "http://localhost:3000/customer/" + customer.id,
            data: customer
          }).done((data) => {
            let str = `  <tr id = "tr_${data.id}">
                          <th scope="row">${data.id}</th>
                          <td>${data.fullName}</td>
                          <td>${data.email}</td>
                          <td>${data.phone}</td>
                          <td>${data.address}</td>
                          <td>${data.balance}</td>
                          <td class="text-center">
                              <button type="button" class="btn btn-outline-secondary edit" data-id = "${data.id}"> <i class="fas fa-pen-square"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-success deposit" id="btnDeposit(${data.id})"> <i class="fas fa-plus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-warning withdraw" id="btnWithdraw(${data.id})"> <i class="fas fa-minus"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-primary transfer" id="btnTransfer(${data.id})"> <i class="fas fa-exchange-alt"></i> </button>
                              <button data-id = "${data.id}" type="button" class="btn btn-outline-danger block" id="btnBlock(${data.id})"> <i class="fas fa-ban"></i> </button>  
                          </td>
             </tr>`;
            let currentRow = $("#tr_" + data.id);
            currentRow.replaceWith(str);

            handleEditBtn();
            $("#mdDeposit").modal("hide");
          })
        }
      })
    })

    $("#btnEdit").on("click", function () {
      let fullName = $('#fullNameUp').val();
      let email = $('#emailUp').val();
      let phone = $('#phoneUp').val();
      let address = $('#addressUp').val();

      customer.fullName = fullName;
      customer.email = email;
      customer.phone = phone;
      customer.address = address;

      $.ajax({
        type: "PUT",
        url: "http://localhost:3000/customer/" + customer.id,
        data: customer
      }).done((data) => {
        let str = `  <tr id = "tr_${data.id}">
                                  <th scope="row">${data.id}</th>
                                  <td>${data.fullName}</td>
                                  <td>${data.email}</td>
                                  <td>${data.phone}</td>
                                  <td>${data.address}</td>
                                  <td>0</td>
                                  <td class="text-center">
                                      <button type="button" class="btn btn-outline-secondary edit" data-id = "${data.id}"> <i class="fas fa-pen-square"></i> </button>
                                      <button data-id = "${data.id}" type="button" class="btn btn-outline-success deposit" id="btnDeposit(${data.id})"> <i class="fas fa-plus"></i> </button>
                                      <button data-id = "${data.id}" type="button" class="btn btn-outline-warning withdraw" id="btnWithdraw(${data.id})"> <i class="fas fa-minus"></i> </button>
                                      <button data-id = "${data.id}" type="button" class="btn btn-outline-primary transfer" id="btnTransfer(${data.id})"> <i class="fas fa-exchange-alt"></i> </button>
                                      <button data-id = "${data.id}" type="button" class="btn btn-outline-danger block" id="btnBlock(${data.id})"> <i class="fas fa-ban"></i> </button>  
                                  </td>
                     </tr>`;
        let currentRow = $("#tr_" + data.id);
        currentRow.replaceWith(str);

        handleEditBtn();
      }).fail((err) => {
        alert("update fail");
      })

      $("#mdEdit").modal("hide");
    })

    function doCreate() {
      let fullName = $('#fullName').val();
      let email = $('#email').val();
      let phone = $('#phone').val();
      let address = $('#address').val();

      delete customer.id;
      customer.fullName = fullName;
      customer.email = email;
      customer.phone = phone;
      customer.address = address;
      customer.balance = 0;
      customer.isDeleted = 0;
      $.ajax({
        type: "POST",
        url: "http://localhost:3000/customer?isDeleted=0",
        data: customer
      }).done((data) => {

        let str = `  <tr id = "tr_${data.id}">
                                <th scope="row">${data.id}</th>
                                <td>${data.fullName}</td>
                                <td>${data.email}</td>
                                <td>${data.phone}</td>
                                <td>${data.address}</td>
                                <td>0</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-outline-secondary edit" data-id = "${data.id}"> <i class="fas fa-pen-square"></i> </button>
                                    <button data-id = "${data.id}" type="button" class="btn btn-outline-success deposit" id="btnDeposit(${data.id})"> <i class="fas fa-plus"></i> </button>
                                    <button data-id = "${data.id}" type="button" class="btn btn-outline-warning withdraw" id="btnWithdraw(${data.id})"> <i class="fas fa-minus"></i> </button>
                                    <button data-id = "${data.id}" type="button" class="btn btn-outline-primary transfer" id="btnTransfer(${data.id})"> <i class="fas fa-exchange-alt"></i> </button>
                                    <button data-id = "${data.id}" type="button" class="btn btn-outline-danger block" id="btnBlock(${data.id})"> <i class="fas fa-ban"></i> </button>  
                                </td>
                            </tr>`;

        $('#tbCustomer tbody').prepend(str);
        handleEditBtn();

      })

      $("#frmCreate")[0].reset();
    }

    $('#btnCreate').on("click", function () {
      $("#frmCreate").submit();
    })

    function loadCustomer() {
      $.ajax({
        type: "GET",
        url: "http://localhost:3000/customer?isDeleted=0"
      }).done((data) => {
        $.each(data, (i, item) => {
          id = item.id;
          let str = `  <tr id = "tr_${item.id}">
                                <th scope="row">${item.id}</th>
                                <td>${item.fullName}</td>
                                <td>${item.email}</td>
                                <td>${item.phone}</td>
                                <td>${item.address}</td>
                                <td>${item.balance}</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-outline-secondary edit" data-id = "${item.id}"> <i class="fas fa-pen-square"></i> </button>
                                    <button data-id = "${item.id}" type="button" class="btn btn-outline-success deposit" id="btnDeposit${item.id}"> <i class="fas fa-plus"></i> </button>
                                    <button data-id = "${item.id}" type="button" class="btn btn-outline-warning withdraw" id="btnWithdraw${item.id}"> <i class="fas fa-minus"></i> </button>
                                    <button data-id = "${item.id}"type="button" class="btn btn-outline-primary transfer" id="btnTransfer${item.id}"> <i class="fas fa-exchange-alt"></i> </button>
                                    <button data-id = "${item.id}"type="button" class="btn btn-outline-danger block" id="btnBlock${item.id}"> <i class="fas fa-ban"></i> </button>  
                                </td> 
                            </tr>`;
          $('#tbCustomer tbody').prepend(str);
        });
        handleEditBtn();
      })


    }


    function getProvince() {
        return $.ajax({
            type: "GET",
            url: "https://vapi.vnappmob.com/api/province/"
        }).done((data) => {
            let province = data.results;
            $.each(province, (i, item) => {

                let str = `<option value="${item.province_id}" >${item.province_name}</option>`;
                $("#province").append(str);
                $("#provinceUp").append(str);
            })
        })
    }


    function handleEditBtn() {
      $('.edit').click(function () {

        let id = $(this).data("id");
        findCustomerById(id).then(function () {
          $("#fullNameUp").val(customer.fullName);
          $("#emailUp").val(customer.email);
          $("#phoneUp").val(customer.phone);
          $("#addressUp").val(customer.address);
          $("#mdEdit").modal("show");
        });
      })

      $(".deposit").on("click", function () {
        let id = $(this).data("id");
        findCustomerById(id).then(function () {
          $("#customerIdDepositUp").val(customer.id);
          $("#fullNameDepositUp").val(customer.fullName);
          $("#balanceDepositUp").val(customer.balance);
          $("#mdDeposit").modal("show");
        });
      })

      $(".withdraw").click(function () {
        let id = $(this).data("id");
        findCustomerById(id).then(function () {
          $("#customerIdWithdraw").val(customer.id);
          $("#fullNameWithdraw").val(customer.fullName);
          $("#balanceWithdraw").val(customer.balance);
          $("#mdWithdraw").modal("show");
        });
      })

      $(".transfer").click(function () {
        let id = $(this).data("id");
        findCustomerById(id).then(function () {
          $("#senderId").val(customer.id);
          $("#senderName").val(customer.fullName);
          $("#senderEmail").val(customer.email);
          $("#senderBalance").val(customer.balance);
          $("#mdTransfer").modal("show");
          showRepName(id);
          calTransactionAmount();
        });
      })
    }

    $("#createCustomer").click(function () {
      $("#mdCreate").modal("show")
    })

    function showRepName(id) {
      console.log("showRepName");
      $.ajax({
        type: "GET",
        url: "http://localhost:3000/customer?isDeleted=0"
      }).done((data) => {
        $.each(data, (i, item) => {
          let str = `<option value="${item.id}" ${(item.id == id) ? "disabled" : ""} >(${item.id}) ${item.fullName}</option>`;
          $("#repName").append(str);
        })
      })
    }



    function findCustomerById(id) {
      return $.ajax({
        type: "GET",
        url: "http://localhost:3000/customer/" + id,
        data: customer
      }).done((data) => {
        customer = data;
      }).fail((err) => {
        alert("Id not found!")
      })
    }

    $("#mdTransfer").on("hidden.bs.modal", function () {
      $("#frmTransfer")[0].reset();
      $("#repName").html("");
    })

    $("#mdDeposit").on("hidden.bs.modal", function () {
      $("#frmDeposit")[0].reset();
    })

    $("#mdWithdraw").on("hidden.bs.modal", function () {
      $("#frmWithdraw")[0].reset();
    })

    $("#mdCreate").on("hidden.bs.modal", function () {
      $("#frmCreate")[0].reset();
      $("#mdCreate .modal-alert-danger").attr("style", "diplay:none");
    })


    function getDatetime() {
      let today = new Date();
      let date = today.getFullYear() + "-" + (today.getMonth() + 1) + "-" + today.getDate();
      return date;
    }

    function calTransactionAmount() {
      $("#transferAmount").on("input", function () {
        let transactionAmount = $("#transferAmount").val();
        $("#transactionAmountTransfer").val(Math.ceil(transactionAmount * 1.1));
      })
    }

    $('#frmCreate').validate({
      rules: {
        fullName: {
          required: true,
          minlength: 3,
          maxlength: 50
        },
        email: {
          required: true,
          email: true,
          minlength: 10,
          maxlength: 50
        },
        address: {
          required: false,
          minlength: 5,
          maxlength: 50
        }
      },
      messages: {
        fullName: {
          required: "Vui lòng nhập tên đầy đủ",
          minlength: $.validator.format("Họ tên tối thiểu {0} ký tự"),
          maxlength: $.validator.format("Họ tên tối đa {0} ký tự")
        },
        email: {
          required: "Vui lòng nhập email đầy đủ",
          email: "Vui lòng nhập đúng định dạng email",
          minlength: $.validator.format("Email tối thiểu {0} ký tự"),
          maxlength: $.validator.format("Email tối đa {0} ký tự")
        },
        address: {
          minlength: $.validator.format("Địa chỉ tối thiểu {0} ký tự"),
          maxlength: $.validator.format("Địa chỉ tối đa {0} ký tự")
        }
      },
      errorElement: 'label',
      errorLabelContainer: '.modal-alert-danger',
      submitHandler: function () {
        doCreate();
      }
    });

    loadCustomer();
  </script>
</body>

</html>